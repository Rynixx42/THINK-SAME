<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wörter-Sync - Multiplayer Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .game-header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .game-header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .game-header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px 15px;
            border-radius: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1000;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .connection-status.offline {
            background: #ff6b6b;
            color: white;
        }

        .screen {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .screen.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input, select, button {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .copy-btn {
            width: auto;
            padding: 8px 16px;
            font-size: 0.9rem;
            margin: 10px 0 0 0;
        }

        .loading-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .lobby-info {
            background: #f8f9fc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .players-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .player-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e1e5e9;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .player-card.host {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }

        .player-card.team-a {
            border-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
        }

        .player-card.team-b {
            border-color: #4ecdc4;
            background: rgba(78, 205, 196, 0.1);
        }

        .player-card.offline {
            opacity: 0.5;
            border-style: dashed;
        }

        .player-card.offline::after {
            content: '📶';
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 0.8rem;
            opacity: 0.5;
        }

        .team-buttons {
            margin-top: 10px;
        }

        .team-buttons button {
            width: auto;
            font-size: 0.7rem;
            padding: 4px 8px;
            margin: 2px;
        }

        .game-area {
            text-align: center;
            padding: 20px;
        }

        .category-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .category-display h2 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .timer {
            font-size: 3rem;
            font-weight: bold;
            color: #667eea;
            margin: 20px 0;
            transition: all 0.3s ease;
        }

        .timer.warning {
            color: #ff6b6b;
            animation: pulse 1s infinite;
        }

        .word-input {
            max-width: 400px;
            margin: 0 auto 30px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e1e5e9;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .result-card {
            background: #f8f9fc;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #667eea;
        }

        .match-percentage {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .streak-display {
            background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .streak-display h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .streak-number {
            font-size: 3rem;
            font-weight: bold;
        }

        .scoreboard {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e1e5e9;
        }

        .score-item:last-child {
            border-bottom: none;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .team-assignment {
            margin: 20px 0;
        }

        .team-section {
            background: #f8f9fc;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        .team-a { border-left: 5px solid #ff6b6b; }
        .team-b { border-left: 5px solid #4ecdc4; }

        .error-message {
            background: #ff6b6b;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }

        .success-message {
            background: #51cf66;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @media (max-width: 768px) {
            .game-header h1 {
                font-size: 2rem;
            }
            
            .container {
                padding: 10px;
            }
            
            .screen {
                padding: 20px;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }

            .connection-status {
                position: relative;
                top: auto;
                right: auto;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="game-header">
            <h1>🎯 Wörter-Sync</h1>
            <p>Das ultimative Multiplayer-Wortspiel</p>
        </div>

        <!-- Connection Status -->
        <div id="connectionStatus" class="connection-status">
            <span id="statusIndicator">🟢</span>
            <span id="statusText">Verbunden</span>
        </div>

        <!-- Start Screen -->
        <div id="startScreen" class="screen active">
            <h2>Willkommen bei Wörter-Sync!</h2>
            <p>Verbinde dich mit anderen Spielern und versucht, auf die gleichen Wörter zu kommen!</p>
            
            <div class="form-group">
                <label for="playerName">Dein Name:</label>
                <input type="text" id="playerName" placeholder="Gib deinen Namen ein..." maxlength="20">
            </div>
            
            <button onclick="showLobbyOptions()">Weiter</button>
        </div>

        <!-- Lobby Options Screen -->
        <div id="lobbyOptionsScreen" class="screen">
            <h2>Lobby-Optionen</h2>
            
            <button onclick="createLobby()" id="createLobbyBtn">
                <span class="loading-spinner" style="display: none;"></span>
                Neue Lobby erstellen
            </button>
            <button onclick="showJoinLobby()">Lobby beitreten</button>
            <button onclick="showStartScreen()">Zurück</button>
            
            <div id="createError" class="error-message"></div>
        </div>

        <!-- Join Lobby Screen -->
        <div id="joinLobbyScreen" class="screen">
            <h2>Lobby beitreten</h2>
            
            <div class="form-group">
                <label for="lobbyCode">Lobby-Code:</label>
                <input type="text" id="lobbyCode" placeholder="Gib den Lobby-Code ein..." maxlength="6">
            </div>
            
            <button onclick="joinLobby()" id="joinLobbyBtn">
                <span class="loading-spinner" style="display: none;"></span>
                Beitreten
            </button>
            <button onclick="showLobbyOptions()">Zurück</button>
            
            <div id="joinError" class="error-message"></div>
        </div>

        <!-- Lobby Screen -->
        <div id="lobbyScreen" class="screen">
            <div class="lobby-info">
                <h2>Lobby: <span id="currentLobbyCode"></span></h2>
                <p>Teile diesen Code mit deinen Freunden!</p>
                <button onclick="copyLobbyCode()" class="copy-btn">📋 Code kopieren</button>
            </div>

            <div id="hostControls" style="display: none;">
                <h3>Spiel-Einstellungen</h3>
                <div class="settings-grid">
                    <div class="form-group">
                        <label for="roundTime">Zeit pro Runde (Sekunden):</label>
                        <select id="roundTime" onchange="updateSettings()">
                            <option value="15">15 Sekunden</option>
                            <option value="30" selected>30 Sekunden</option>
                            <option value="45">45 Sekunden</option>
                            <option value="60">60 Sekunden</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="totalRounds">Anzahl Runden:</label>
                        <select id="totalRounds" onchange="updateSettings()">
                            <option value="3">3 Runden</option>
                            <option value="5" selected>5 Runden</option>
                            <option value="7">7 Runden</option>
                            <option value="10">10 Runden</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="matchThreshold">Mindest-Übereinstimmung (%):</label>
                        <select id="matchThreshold" onchange="updateSettings()">
                            <option value="70">70%</option>
                            <option value="80">80%</option>
                            <option value="90" selected>90%</option>
                            <option value="100">100%</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="gameMode">Spielmodus:</label>
                        <select id="gameMode" onchange="toggleTeamMode()">
                            <option value="all">Alle zusammen</option>
                            <option value="teams">Team-Modus</option>
                        </select>
                    </div>
                </div>

                <div id="teamAssignment" class="team-assignment" style="display: none;">
                    <h3>Team-Aufteilung</h3>
                    <div class="team-section team-a">
                        <h4>Team A (Rot)</h4>
                        <div id="teamAPlayers"></div>
                    </div>
                    <div class="team-section team-b">
                        <h4>Team B (Türkis)</h4>
                        <div id="teamBPlayers"></div>
                    </div>
                </div>
            </div>

            <h3>Spieler in der Lobby (<span id="playerCount">0</span>):</h3>
            <div id="playersList" class="players-list"></div>

            <div id="hostActions" style="display: none;">
                <button onclick="startGame()" id="startGameBtn">
                    <span class="loading-spinner" style="display: none;"></span>
                    Spiel starten
                </button>
            </div>
            
            <button onclick="leaveLobby()">Lobby verlassen</button>
        </div>

        <!-- Game Screen -->
        <div id="gameScreen" class="screen">
            <div class="game-area">
                <div class="category-display">
                    <h2 id="currentCategory">Kategorie wird geladen...</h2>
                    <p>Runde <span id="currentRound">1</span> von <span id="maxRounds">5</span></p>
                </div>

                <div class="timer" id="gameTimer">30</div>

                <div class="word-input">
                    <input type="text" id="wordAnswer" placeholder="Dein Wort eingeben..." maxlength="50">
                    <button onclick="submitWord()" id="submitBtn">
                        <span class="loading-spinner" style="display: none;"></span>
                        Wort absenden
                    </button>
                </div>

                <div id="waitingMessage" style="display: none;">
                    <h3>Warten auf andere Spieler...</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <p id="answeredCount">0 von 0 Spielern haben geantwortet</p>
                </div>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="resultsScreen" class="screen">
            <h2>Runden-Ergebnis</h2>
            
            <div class="streak-display">
                <h3>Aktuelle Serie</h3>
                <div class="streak-number" id="currentStreak">0</div>
            </div>

            <div id="matchResults" class="results-grid"></div>

            <div class="scoreboard">
                <h3>Punktestand</h3>
                <div id="scoreList"></div>
            </div>

            <button onclick="nextRound()" id="nextRoundBtn" style="display: none;">
                <span class="loading-spinner" style="display: none;"></span>
                Nächste Runde
            </button>
            <button onclick="showFinalResults()" id="showFinalBtn" style="display: none;">Endergebnis anzeigen</button>
        </div>

        <!-- Final Results Screen -->
        <div id="finalScreen" class="screen">
            <h2>🏆 Spiel beendet!</h2>
            
            <div class="scoreboard">
                <h3>Endergebnis</h3>
                <div id="finalScoreList"></div>
            </div>

            <div id="winnerAnnouncement" class="streak-display">
                <h3 id="winnerText">Gewinner wird ermittelt...</h3>
            </div>

            <button onclick="playAgain()">Nochmal spielen</button>
            <button onclick="leaveLobby()">Lobby verlassen</button>
        </div>
    </div>

    <script>
        // ===============================
        // Network API Class
        // ===============================

        class NetworkAPI {
            constructor() {
                this.baseURL = '/.netlify/functions';
                this.pollInterval = null;
                this.isOnline = true;
                this.useMockData = !this.isNetlifyEnvironment();
            }

            isNetlifyEnvironment() {
                return window.location.hostname.includes('netlify.app') || 
                       window.location.hostname.includes('netlify.com') ||
                       window.location.hostname === 'localhost' && window.location.port === '8888';
            }

            async request(endpoint, options = {}) {
                if (this.useMockData) {
                    return this.mockRequest(endpoint, options);
                }

                try {
                    const response = await fetch(`${this.baseURL}${endpoint}`, {
                        headers: { 'Content-Type': 'application/json' },
                        ...options
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    this.updateConnectionStatus(true);
                    return data;
                } catch (error) {
                    console.error('Network request failed:', error);
                    this.updateConnectionStatus(false);
                    // Fallback to mock data if network fails
                    return this.mockRequest(endpoint, options);
                }
            }

            // Mock API für lokale Entwicklung und Fallback
            mockRequest(endpoint, options = {}) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        const body = options.body ? JSON.parse(options.body) : {};
                        
                        switch (endpoint) {
                            case '/create-lobby':
                                const lobbyCode = Math.random().toString(36).substr(2, 6).toUpperCase();
                                resolve({
                                    success: true,
                                    lobbyCode,
                                    lobby: this.createMockLobby(lobbyCode, body.playerId, body.playerName, true)
                                });
                                break;
                                
                            case '/join-lobby':
                                resolve({
                                    success: true,
                                    lobby: this.createMockLobby(body.lobbyCode, body.playerId, body.playerName, false)
                                });
                                break;
                                
                            case endpoint.startsWith('/update-lobby') ? endpoint : null:
                                resolve({
                                    success: true,
                                    lobby: this.getMockLobbyUpdate()
                                });
                                break;
                                
                            case '/start-game':
                                resolve({
                                    success: true,
                                    lobby: this.startMockGame()
                                });
                                break;
                                
                            case '/submit-answer':
                                resolve({
                                    success: true,
                                    roundComplete: true,
                                    results: this.getMockResults()
                                });
                                break;
                                
                            default:
                                resolve({ success: false, error: 'Unknown endpoint' });
                        }
                    }, Math.random() * 500 + 200); // Simulate network delay
                });
            }

            createMockLobby(code, playerId, playerName, isHost) {
                const players = [
                    { id: playerId, name: playerName, isHost, team: null, connected: true, lastSeen: Date.now() }
                ];

                if (!isHost) {
                    players.unshift(
                        { id: 'host123', name: 'Anna', isHost: true, team: null, connected: true, lastSeen: Date.now() },
                        { id: 'player2', name: 'Ben', isHost: false, team: null, connected: true, lastSeen: Date.now() }
                    );
                }

                return {
                    code,
                    hostId: isHost ? playerId : 'host123',
                    players,
                    settings: {
                        roundTime: 30,
                        totalRounds: 5,
                        matchThreshold: 90,
                        gameMode: 'all'
                    },
                    gameState: {
                        isActive: false,
                        currentRound: 0,
                        currentCategory: null,
                        roundAnswers: [],
                        scores: players.map(p => [p.id, 0]),
                        streak: 0,
                        roundStartTime: null
                    }
                };
            }

            getMockLobbyUpdate() {
                return game.lobby || this.createMockLobby('ABC123', game.playerId, game.playerName, game.isHost);
            }

            startMockGame() {
                const categories = [
                    'Bücher',  
                    'Musikalben',  
                    'Songtexte',  
                    'Reimwörter',  
                    'Lügen',  
                    'Träume',  
                    'Peinliche Situationen',  
                    'Kinderserien',  
                    'Tanzarten',  
                    'Uhrenmarken',  
                    'Parfümmarken',  
                    'Fast-Food-Ketten',  
                    'Spielzeug',  
                    'Haarschnitte',  
                    'Süßspeisen',  
                    'Gewürze',  
                    'Kulturen',  
                    'Religionen',  
                    'Bücherfiguren',  
                    'Gefährliche Orte',  
                    'Filmwaffen',  
                    'Detektive',  
                    'Tatorte',  
                    'Kriminalfälle',  
                    'Modeaccessoires',  
                    'Verkehrsunfälle',  
                    'Bewegungsverben',  
                    'Feste & Feiertage',  
                    'Typisch deutsch',  
                    'Typisch amerikanisch',  
                    'Typisch asiatisch',  
                    'Typisch französisch',  
                    'Schulnoten-Gründe',  
                    'Sprüche von Eltern',  
                    'Berühmte Paare',  
                    'Lügengeschichten',  
                    'Wahrheiten, die wehtun',  
                    'Versicherungen',  
                    'Küchengeräte',  
                    'Wörter aus der Werbung',  
                    'TV-Werbeslogans',  
                    'Pseudonyme',  
                    'Hackernamen',  
                    'Slangbegriffe',  
                    'Jugendwörter',  
                    'Spitznamen',  
                    'Kosename für Partner',  
                    'Letzte Worte',  
                    'Szenarien bei Apokalypse',  
                    'Bösewichtnamen',  
                    'Wissenschaftler*innen',  
                    'Historische Figuren',  
                    'Wichtige Jahreszahlen',  
                    'Sprengstoffe',  
                    'Todesursachen',  
                    'Seltsame Hobbys',  
                    'Wünsche',  
                    'Ängste',  
                    'Künstlernamen',  
                    'Götter & Göttinnen',  
                    'Fantasy-Rassen',  
                    'Magische Gegenstände',  
                    'Krankenkassen',  
                    'Verkehrsregeln',  
                    'Sinnlose Dinge',  
                    'Berühmte Reden',  
                    'Böse Berufe',  
                    'Alienspezies',  
                    'Lustige Orte',  
                    'Nervige Dinge',  
                    'Berühmte Brücken',  
                    'Flüsse',  
                    'Seen',  
                    'Extremtemperaturen',  
                    'TV-Wettermoderatoren',  
                    'Sachen, die man nicht vergisst',  
                    'Unnützes Wissen',  
                    'Sachen, die man im Internet findet',  
                    'Typische Fragen im Bewerbungsgespräch',  
                    'Dinge, die Lehrer sagen',  
                    'Unerklärliche Dinge',  
                    'Kuriose Berufe',  
                    'Berühmte Redensarten'  
                ];
                
                const lobby = this.getMockLobbyUpdate();
                lobby.gameState.isActive = true;
                lobby.gameState.currentRound = 1;
                lobby.gameState.currentCategory = categories[Math.floor(Math.random() * categories.length)];
                lobby.gameState.roundStartTime = Date.now();
                
                return lobby;
            }

            getMockResults() {
                const mockAnswers = ['pizza', 'pasta', 'pizza', 'brot'];
                return {
                    mostCommonAnswer: 'pizza',
                    matchCount: 2,
                    matchPercentage: 50,
                    roundSuccess: false,
                    streak: 0,
                    allAnswers: [
                        [game.playerId, 'pizza'],
                        ['host123', 'pasta'],
                        ['player2', 'pizza'],
                        ['player3', 'brot']
                    ]
                };
            }

            async createLobby(playerName, playerId) {
                return this.request('/create-lobby', {
                    method: 'POST',
                    body: JSON.stringify({ playerName, playerId })
                });
            }

            async joinLobby(lobbyCode, playerName, playerId) {
                return this.request('/join-lobby', {
                    method: 'POST',
                    body: JSON.stringify({ lobbyCode, playerName, playerId })
                });
            }

            async updateLobby(lobbyCode, playerId, action, data = {}) {
                return this.request('/update-lobby', {
                    method: 'POST',
                    body: JSON.stringify({ lobbyCode, playerId, action, data })
                });
            }

            async getLobbyStatus(lobbyCode, playerId) {
                return this.request(`/update-lobby?code=${lobbyCode}&playerId=${playerId}`);
            }

            async startGame(lobbyCode, playerId) {
                return this.request('/start-game', {
                    method: 'POST',
                    body: JSON.stringify({ lobbyCode, playerId })
                });
            }

            async submitAnswer(lobbyCode, playerId, answer) {
                return this.request('/submit-answer', {
                    method: 'POST',
                    body: JSON.stringify({ lobbyCode, playerId, answer })
                });
            }

            startPolling(lobbyCode, playerId, callback) {
                this.stopPolling();
                this.pollInterval = setInterval(async () => {
                    try {
                        const result = await this.getLobbyStatus(lobbyCode, playerId);
                        if (result.success) {
                            callback(result.lobby);
                        }
                    } catch (error) {
                        console.error('Polling error:', error);
                    }
                }, 2000);
            }

            stopPolling() {
                if (this.pollInterval) {
                    clearInterval(this.pollInterval);
                    this.pollInterval = null;
                }
            }

            updateConnectionStatus(isOnline) {
                this.isOnline = isOnline;
                const statusIndicator = document.getElementById('statusIndicator');
                const statusText = document.getElementById('statusText');
                const connectionStatus = document.getElementById('connectionStatus');

                if (isOnline) {
                    statusIndicator.textContent = '🟢';
                    statusText.textContent = this.useMockData ? 'Demo-Modus' : 'Verbunden';
                    connectionStatus.classList.remove('offline');
                } else {
                    statusIndicator.textContent = '🔴';
                    statusText.textContent = 'Verbindung verloren';
                    connectionStatus.classList.add('offline');
                }
            }
        }

        // ===============================
        // Game State Management
        // ===============================

        class GameState {
            constructor() {
                this.playerId = this.generateId();
                this.playerName = '';
                this.lobbyCode = '';
                this.isHost = false;
                this.lobby = null;
                this.gameTimer = null;
                this.lastLobbyUpdate = 0;
            }

            generateId() {
                return Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
            }

            updateLobby(lobbyData) {
                this.lobby = lobbyData;
                this.lastLobbyUpdate = Date.now();
                
                // Update UI based on lobby state
                if (lobbyData.gameState.isActive) {
                    this.handleGameState();
                } else {
                    this.updateLobbyUI();
                }
            }

            handleGameState() {
                const gameState = this.lobby.gameState;
                
                if (gameState.currentCategory && !document.getElementById('gameScreen').classList.contains('active')) {
                    this.startGameRound();
                }
                
                // Check if round is complete
                if (gameState.roundAnswers && this.hasPlayerAnswered()) {
                    this.showWaitingForOthers();
                }
            }

            hasPlayerAnswered() {
                return this.lobby.gameState.roundAnswers.some(([playerId]) => playerId === this.playerId);
            }

            startGameRound() {
                const gameState = this.lobby.gameState;
                
                document.getElementById('currentCategory').textContent = gameState.currentCategory;
                document.getElementById('currentRound').textContent = gameState.currentRound;
                document.getElementById('maxRounds').textContent = this.lobby.settings.totalRounds;
                
                // Reset input
                document.getElementById('wordAnswer').value = '';
                document.getElementById('wordAnswer').disabled = false;
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('waitingMessage').style.display = 'none';
                
                showScreen('gameScreen');
                this.startTimer();
            }

            startTimer() {
                if (this.gameTimer) {
                    clearInterval(this.gameTimer);
                }

                const roundStartTime = this.lobby.gameState.roundStartTime;
                const roundTime = this.lobby.settings.roundTime;
                const timerDisplay = document.getElementById('gameTimer');
                
                const updateTimer = () => {
                    const elapsed = (Date.now() - roundStartTime) / 1000;
                    const timeLeft = Math.max(0, roundTime - elapsed);
                    
                    timerDisplay.textContent = Math.ceil(timeLeft);
                    
                    if (timeLeft <= 10) {
                        timerDisplay.classList.add('warning');
                    } else {
                        timerDisplay.classList.remove('warning');
                    }
                    
                    if (timeLeft <= 0) {
                        clearInterval(this.gameTimer);
                        this.timeUp();
                    }
                };
                
                updateTimer();
                this.gameTimer = setInterval(updateTimer, 100);
            }

            timeUp() {
                document.getElementById('wordAnswer').disabled = true;
                document.getElementById('submitBtn').disabled = true;
                this.showWaitingForOthers();
            }

            showWaitingForOthers() {
                document.getElementById('waitingMessage').style.display = 'block';
                
                const answeredCount = this.lobby.gameState.roundAnswers.length;
                const totalPlayers = this.lobby.players.length;
                const progress = (answeredCount / totalPlayers) * 100;
                
                document.getElementById('progressFill').style.width = `${progress}%`;
                document.getElementById('answeredCount').textContent = `${answeredCount} von ${totalPlayers} Spielern haben geantwortet`;
            }

            updateLobbyUI() {
                if (!this.lobby) return;
                
                document.getElementById('currentLobbyCode').textContent = this.lobby.code;
                document.getElementById('playerCount').textContent = this.lobby.players.length;
                
                // Show/hide host controls
                const isHost = this.lobby.hostId === this.playerId;
                document.getElementById('hostControls').style.display = isHost ? 'block' : 'none';
                document.getElementById('hostActions').style.display = isHost ? 'block' : 'none';
                
                // Update players list
                this.updatePlayersList();
                
                // Update start button
                this.updateStartButton();
            }

            updatePlayersList() {
                const playersList = document.getElementById('playersList');
                playersList.innerHTML = '';
                
                this.lobby.players.forEach(player => {
                    const playerCard = document.createElement('div');
                    playerCard.className = 'player-card';
                    
                    if (player.isHost) {
                        playerCard.classList.add('host');
                    }
                    
                    if (player.team === 'A') {
                        playerCard.classList.add('team-a');
                    } else if (player.team === 'B') {
                        playerCard.classList.add('team-b');
                    }
                    
                    // Check if player is online (last seen within 30 seconds)
                    const isOnline = player.lastSeen && (Date.now() - player.lastSeen) < 30000;
                    if (!isOnline) {
                        playerCard.classList.add('offline');
                    }
                    
                    let teamButtons = '';
                    if (this.lobby.hostId === this.playerId && !player.isHost && this.lobby.settings.gameMode === 'teams') {
                        teamButtons = `
                            <div class="team-buttons">
                                <button onclick="assignTeam('${player.id}', 'A')">Team A</button>
                                <button onclick="assignTeam('${player.id}', 'B')">Team B</button>
                                <button onclick="assignTeam('${player.id}', null)">Kein Team</button>
                            </div>
                        `;
                    }
                    
                    playerCard.innerHTML = `
                        <strong>${player.name}</strong>
                        ${player.isHost ? '<br><small>👑 Host</small>' : ''}
                        ${player.team ? `<br><small>Team ${player.team}</small>` : ''}
                        ${teamButtons}
                    `;
                    
                    playersList.appendChild(playerCard);
                });
                
                this.updateTeamDisplay();
            }

            updateTeamDisplay() {
                const teamADiv = document.getElementById('teamAPlayers');
                const teamBDiv = document.getElementById('teamBPlayers');
                
                if (teamADiv && teamBDiv) {
                    teamADiv.innerHTML = '';
                    teamBDiv.innerHTML = '';
                    
                    this.lobby.players.forEach(player => {
                        if (player.team === 'A') {
                            teamADiv.innerHTML += `<span style="display: inline-block; margin: 5px; padding: 5px 10px; background: rgba(255,107,107,0.2); border-radius: 5px;">${player.name}</span>`;
                        } else if (player.team === 'B') {
                            teamBDiv.innerHTML += `<span style="display: inline-block; margin: 5px; padding: 5px 10px; background: rgba(78,205,196,0.2); border-radius: 5px;">${player.name}</span>`;
                        }
                    });
                }
            }

            updateStartButton() {
                const startBtn = document.getElementById('startGameBtn');
                if (startBtn && this.lobby.hostId === this.playerId) {
                    const canStart = this.lobby.players.length >= 2;
                    startBtn.disabled = !canStart;
                    
                    if (!canStart) {
                        startBtn.textContent = 'Mindestens 2 Spieler benötigt';
                    } else {
                        startBtn.textContent = 'Spiel starten';
                    }
                }
            }
        }

        // ===============================
        // Global Variables
        // ===============================

        const api = new NetworkAPI();
        const game = new GameState();

        // ===============================
        // Screen Management
        // ===============================

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        function showStartScreen() {
            api.stopPolling();
            showScreen('startScreen');
        }

        function showLobbyOptions() {
            const name = document.getElementById('playerName').value.trim();
            if (!name) {
                showError('Bitte gib einen Namen ein!');
                return;
            }
            game.playerName = name;
            showScreen('lobbyOptionsScreen');
        }

        function showJoinLobby() {
            showScreen('joinLobbyScreen');
        }

        // ===============================
        // Lobby Management
        // ===============================

        async function createLobby() {
            const btn = document.getElementById('createLobbyBtn');
            
            setButtonLoading(btn, true);
            
            try {
                const result = await api.createLobby(game.playerName, game.playerId);
                
                if (result.success) {
                    game.lobbyCode = result.lobbyCode;
                    game.isHost = true;
                    game.updateLobby(result.lobby);
                    
                    // Start polling for lobby updates
                    api.startPolling(game.lobbyCode, game.playerId, (lobbyData) => {
                        game.updateLobby(lobbyData);
                    });
                    
                    showScreen('lobbyScreen');
                } else {
                    showError(result.error || 'Fehler beim Erstellen der Lobby');
                }
            } catch (error) {
                showError('Verbindungsfehler. Bitte versuche es erneut.');
            } finally {
                setButtonLoading(btn, false);
            }
        }

        async function joinLobby() {
            const code = document.getElementById('lobbyCode').value.trim().toUpperCase();
            const btn = document.getElementById('joinLobbyBtn');
            
            if (!code) {
                showError('Bitte gib einen Lobby-Code ein!');
                return;
            }

            setButtonLoading(btn, true);
            
            try {
                const result = await api.joinLobby(code, game.playerName, game.playerId);
                
                if (result.success) {
                    game.lobbyCode = code;
                    game.isHost = false;
                    game.updateLobby(result.lobby);
                    
                    // Start polling for lobby updates
                    api.startPolling(game.lobbyCode, game.playerId, (lobbyData) => {
                        game.updateLobby(lobbyData);
                    });
                    
                    showScreen('lobbyScreen');
                } else {
                    showError(result.error || 'Fehler beim Beitreten der Lobby');
                }
            } catch (error) {
                showError('Verbindungsfehler. Bitte versuche es erneut.');
            } finally {
                setButtonLoading(btn, false);
            }
        }

        async function leaveLobby() {
            api.stopPolling();
            
            // Reset game state
            game.lobbyCode = '';
            game.isHost = false;
            game.lobby = null;
            
            if (game.gameTimer) {
                clearInterval(game.gameTimer);
                game.gameTimer = null;
            }
            
            showScreen('startScreen');
        }

        async function updateSettings() {
            if (!game.isHost || !game.lobby) return;
            
            const settings = {
                roundTime: parseInt(document.getElementById('roundTime').value),
                totalRounds: parseInt(document.getElementById('totalRounds').value),
                matchThreshold: parseInt(document.getElementById('matchThreshold').value),
                gameMode: document.getElementById('gameMode').value
            };
            
            try {
                await api.updateLobby(game.lobbyCode, game.playerId, 'updateSettings', settings);
            } catch (error) {
                console.error('Error updating settings:', error);
            }
        }

        async function toggleTeamMode() {
            const gameMode = document.getElementById('gameMode').value;
            const teamAssignment = document.getElementById('teamAssignment');
            
            if (gameMode === 'teams') {
                teamAssignment.style.display = 'block';
            } else {
                teamAssignment.style.display = 'none';
            }
            
            await updateSettings();
        }

        async function assignTeam(playerId, team) {
            if (!game.isHost) return;
            
            try {
                await api.updateLobby(game.lobbyCode, game.playerId, 'assignTeam', {
                    targetPlayerId: playerId,
                    team: team
                });
            } catch (error) {
                console.error('Error assigning team:', error);
            }
        }

        function copyLobbyCode() {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(game.lobbyCode);
                showSuccess('Lobby-Code kopiert!');
            } else {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = game.lobbyCode;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showSuccess('Lobby-Code kopiert!');
            }
        }

        // ===============================
        // Game Logic
        // ===============================

        async function startGame() {
            if (!game.isHost) return;
            
            const btn = document.getElementById('startGameBtn');
            setButtonLoading(btn, true);
            
            try {
                const result = await api.startGame(game.lobbyCode, game.playerId);
                
                if (result.success) {
                    game.updateLobby(result.lobby);
                } else {
                    showError(result.error || 'Fehler beim Starten des Spiels');
                }
            } catch (error) {
                showError('Verbindungsfehler. Bitte versuche es erneut.');
            } finally {
                setButtonLoading(btn, false);
            }
        }

        async function submitWord() {
            const word = document.getElementById('wordAnswer').value.trim();
            const btn = document.getElementById('submitBtn');
            
            if (!word) {
                showError('Bitte gib ein Wort ein!');
                return;
            }
            
            setButtonLoading(btn, true);
            
            try {
                const result = await api.submitAnswer(game.lobbyCode, game.playerId, word);
                
                if (result.success) {
                    document.getElementById('wordAnswer').disabled = true;
                    document.getElementById('submitBtn').disabled = true;
                    
                    if (result.roundComplete && result.results) {
                        showResults(result.results);
                    } else {
                        game.showWaitingForOthers();
                    }
                } else {
                    showError(result.error || 'Fehler beim Senden der Antwort');
                }
            } catch (error) {
                showError('Verbindungsfehler. Bitte versuche es erneut.');
            } finally {
                setButtonLoading(btn, false);
            }
        }

        function showResults(results) {
            // Update streak display
            document.getElementById('currentStreak').textContent = results.streak;
            
            // Display results
            const resultsGrid = document.getElementById('matchResults');
            resultsGrid.innerHTML = '';
            
            // Main result card
            const mainResult = document.createElement('div');
            mainResult.className = 'result-card';
            mainResult.innerHTML = `
                <div class="match-percentage">${results.matchPercentage}%</div>
                <h3>Übereinstimmung</h3>
                <p><strong>"${results.mostCommonAnswer}"</strong> wurde ${results.matchCount}x genannt</p>
                <p>${results.roundSuccess ? '✅ Runde erfolgreich!' : '❌ Zu wenig Übereinstimmung'}</p>
            `;
            resultsGrid.appendChild(mainResult);
            
            // All answers card
            const answersResult = document.createElement('div');
            answersResult.className = 'result-card';
            let answersHtml = '<h3>Alle Antworten:</h3>';
            
            results.allAnswers.forEach(([playerId, answer]) => {
                const player = game.lobby.players.find(p => p.id === playerId);
                const playerName = player ? player.name : 'Unbekannt';
                const isMatch = answer === results.mostCommonAnswer;
                answersHtml += `<p>${playerName}: <strong>${answer || '(keine Antwort)'}</strong> ${isMatch ? '✅' : ''}</p>`;
            });
            
            answersResult.innerHTML = answersHtml;
            resultsGrid.appendChild(answersResult);
            
            // Update scoreboard
            updateScoreboard();
            
            // Show appropriate buttons
            const nextRoundBtn = document.getElementById('nextRoundBtn');
            const showFinalBtn = document.getElementById('showFinalBtn');
            
            if (game.lobby.gameState.currentRound < game.lobby.settings.totalRounds) {
                nextRoundBtn.style.display = 'inline-block';
                showFinalBtn.style.display = 'none';
                
                if (game.isHost) {
                    nextRoundBtn.textContent = 'Nächste Runde starten';
                    nextRoundBtn.disabled = false;
                } else {
                    nextRoundBtn.textContent = 'Warten auf Host...';
                    nextRoundBtn.disabled = true;
                }
            } else {
                nextRoundBtn.style.display = 'none';
                showFinalBtn.style.display = 'inline-block';
                
                if (game.isHost) {
                    showFinalBtn.textContent = 'Endergebnis anzeigen';
                    showFinalBtn.disabled = false;
                } else {
                    showFinalBtn.textContent = 'Warten auf Host...';
                    showFinalBtn.disabled = true;
                }
            }
            
            showScreen('resultsScreen');
        }

        function updateScoreboard() {
            const scoreList = document.getElementById('scoreList');
            scoreList.innerHTML = '';
            
            if (!game.lobby || !game.lobby.gameState.scores) return;
            
            // Sort players by score
            const sortedScores = [...game.lobby.gameState.scores].sort((a, b) => b[1] - a[1]);
            
            sortedScores.forEach(([playerId, score], index) => {
                const player = game.lobby.players.find(p => p.id === playerId);
                if (!player) return;
                
                const scoreItem = document.createElement('div');
                scoreItem.className = 'score-item';
                
                let rankEmoji = '';
                if (index === 0) rankEmoji = '🥇';
                else if (index === 1) rankEmoji = '🥈';
                else if (index === 2) rankEmoji = '🥉';
                else rankEmoji = `${index + 1}.`;
                
                scoreItem.innerHTML = `
                    <span>${rankEmoji} ${player.name}</span>
                    <span><strong>${score} Punkte</strong></span>
                `;
                
                scoreList.appendChild(scoreItem);
            });
        }

        async function nextRound() {
            if (!game.isHost) return;
            
            const btn = document.getElementById('nextRoundBtn');
            setButtonLoading(btn, true);
            
            try {
                // Start next round by updating game state
                await api.updateLobby(game.lobbyCode, game.playerId, 'nextRound');
            } catch (error) {
                console.error('Error starting next round:', error);
            } finally {
                setButtonLoading(btn, false);
            }
        }

        function showFinalResults() {
            updateFinalScoreboard();
            determineWinner();
            showScreen('finalScreen');
        }

        function updateFinalScoreboard() {
            const finalScoreList = document.getElementById('finalScoreList');
            finalScoreList.innerHTML = '';
            
            if (!game.lobby || !game.lobby.gameState.scores) return;
            
            // Sort players by score
            const sortedScores = [...game.lobby.gameState.scores].sort((a, b) => b[1] - a[1]);
            
            sortedScores.forEach(([playerId, score], index) => {
                const player = game.lobby.players.find(p => p.id === playerId);
                if (!player) return;
                
                const scoreItem = document.createElement('div');
                scoreItem.className = 'score-item';
                
                let rankEmoji = '';
                if (index === 0) rankEmoji = '🏆';
                else if (index === 1) rankEmoji = '🥈';
                else if (index === 2) rankEmoji = '🥉';
                else rankEmoji = `${index + 1}.`;
                
                scoreItem.innerHTML = `
                    <span>${rankEmoji} ${player.name}</span>
                    <span><strong>${score} Punkte</strong></span>
                `;
                
                finalScoreList.appendChild(scoreItem);
            });
        }

        function determineWinner() {
            const winnerText = document.getElementById('winnerText');
            
            if (!game.lobby || !game.lobby.gameState.scores) {
                winnerText.textContent = 'Fehler beim Laden der Ergebnisse';
                return;
            }
            
            if (game.lobby.settings.gameMode === 'teams') {
                // Calculate team scores
                const teamAScore = game.lobby.players
                    .filter(player => player.team === 'A')
                    .reduce((total, player) => {
                        const score = game.lobby.gameState.scores.find(([id]) => id === player.id);
                        return total + (score ? score[1] : 0);
                    }, 0);
                
                const teamBScore = game.lobby.players
                    .filter(player => player.team === 'B')
                    .reduce((total, player) => {
                        const score = game.lobby.gameState.scores.find(([id]) => id === player.id);
                        return total + (score ? score[1] : 0);
                    }, 0);
                
                if (teamAScore > teamBScore) {
                    winnerText.textContent = '🏆 Team A gewinnt!';
                } else if (teamBScore > teamAScore) {
                    winnerText.textContent = '🏆 Team B gewinnt!';
                } else {
                    winnerText.textContent = '🤝 Unentschieden!';
                }
            } else {
                // Individual winner
                const sortedScores = [...game.lobby.gameState.scores].sort((a, b) => b[1] - a[1]);
                if (sortedScores.length > 0) {
                    const winnerId = sortedScores[0][0];
                    const winner = game.lobby.players.find(p => p.id === winnerId);
                    if (winner) {
                        winnerText.textContent = `🏆 ${winner.name} gewinnt!`;
                    }
                }
            }
        }

        function playAgain() {
            // Reset to lobby screen for new game
            showScreen('lobbyScreen');
        }

        // ===============================
        // Utility Functions
        // ===============================

        function setButtonLoading(button, isLoading) {
            const spinner = button.querySelector('.loading-spinner');
            if (isLoading) {
                spinner.style.display = 'inline-block';
                button.disabled = true;
            } else {
                spinner.style.display = 'none';
                button.disabled = false;
            }
        }

        function showError(message) {
            // Create temporary error message
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            errorDiv.style.position = 'fixed';
            errorDiv.style.top = '80px';
            errorDiv.style.left = '50%';
            errorDiv.style.transform = 'translateX(-50%)';
            errorDiv.style.zIndex = '9999';
            errorDiv.style.maxWidth = '90%';
            
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                if (document.body.contains(errorDiv)) {
                    document.body.removeChild(errorDiv);
                }
            }, 5000);
        }

        function showSuccess(message) {
            // Create temporary success message
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            successDiv.style.position = 'fixed';
            successDiv.style.top = '80px';
            successDiv.style.left = '50%';
            successDiv.style.transform = 'translateX(-50%)';
            successDiv.style.zIndex = '9999';
            successDiv.style.maxWidth = '90%';
            
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                if (document.body.contains(successDiv)) {
                    document.body.removeChild(successDiv);
                }
            }, 3000);
        }

        // ===============================
        // Event Listeners
        // ===============================

        document.addEventListener('DOMContentLoaded', function() {
            // Enter key support for inputs
            document.getElementById('playerName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    showLobbyOptions();
                }
            });
            
            document.getElementById('lobbyCode').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    joinLobby();
                }
            });
            
            document.getElementById('wordAnswer').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    submitWord();
                }
            });
            
            // Auto-focus inputs
            setTimeout(() => {
                const playerNameInput = document.getElementById('playerName');
                if (playerNameInput) {
                    playerNameInput.focus();
                }
            }, 100);
            
            // Handle page visibility changes
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    // Page is hidden, reduce polling frequency
                    if (api.pollInterval) {
                        api.stopPolling();
                        if (game.lobbyCode && game.playerId) {
                            setTimeout(() => {
                                api.startPolling(game.lobbyCode, game.playerId, (lobbyData) => {
                                    game.updateLobby(lobbyData);
                                });
                            }, 5000); // Restart with delay
                        }
                    }
                } else {
                    // Page is visible, resume normal polling
                    if (game.lobbyCode && game.playerId) {
                        api.stopPolling();
                        api.startPolling(game.lobbyCode, game.playerId, (lobbyData) => {
                            game.updateLobby(lobbyData);
                        });
                    }
                }
            });
            
            // Handle beforeunload
            window.addEventListener('beforeunload', function() {
                api.stopPolling();
            });
        });

        // ===============================
        // Initialize
        // ===============================

        console.log('🎯 Wörter-Sync Game initialized!');
        console.log('Player ID:', game.playerId);

        // Check environment and show appropriate status
        if (api.useMockData) {
            console.log('📱 Demo-Modus - Funktionen werden simuliert');
            console.log('🚀 Für Produktion: Netlify Functions deployen');
        } else {
            console.log('🌐 Produktions-Modus - Netlify Functions aktiv');
        }

        // Initialize connection status
        api.updateConnectionStatus(true);
    </script>
</body>
</html>